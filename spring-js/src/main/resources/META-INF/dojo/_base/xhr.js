/*
	Copyright (c) 2004-2007, The Dojo Foundation
	All Rights Reserved.

	Licensed under the Academic Free License version 2.1 or above OR the
	modified BSD license. For more information on Dojo licensing, see:

		http://dojotoolkit.org/book/dojo-book-0-9/introduction/licensing
*/


if(!dojo._hasResource["dojo._base.xhr"]){dojo._hasResource["dojo._base.xhr"]=true;dojo.provide("dojo._base.xhr");dojo.require("dojo._base.Deferred");dojo.require("dojo._base.json");dojo.require("dojo._base.lang");dojo.require("dojo._base.query");(function(){var _d=dojo;function setValue(_2,_3,_4){var _5=_2[_3];if(_d.isString(_5)){_2[_3]=[_5,_4];}else{if(_d.isArray(_5)){_5.push(_4);}else{_2[_3]=_4;}}};dojo.formToObject=function(_6){var _7={};var iq="input:not([type=file]):not([type=submit]):not([type=image]):not([type=reset]):not([type=button]), select, textarea";_d.query(iq,_6).filter(function(_9){return (!_9.disabled);}).forEach(function(_a){var _b=_a.name;var _c=(_a.type||"").toLowerCase();if(_c=="radio"||_c=="checkbox"){if(_a.checked){setValue(_7,_b,_a.value);}}else{if(_a.multiple){_7[_b]=[];_d.query("option",_a).forEach(function(_d){if(_d.selected){setValue(_7,_b,_d.value);}});}else{setValue(_7,_b,_a.value);if(_c=="image"){_7[_b+".x"]=_7[_b+".y"]=_7[_b].x=_7[_b].y=0;}}}});return _7;};dojo.objectToQuery=function(_e){var ec=encodeURIComponent;var ret="";var _11={};for(var x in _e){if(_e[x]!=_11[x]){if(_d.isArray(_e[x])){for(var y=0;y<_e[x].length;y++){ret+=ec(x)+"="+ec(_e[x][y])+"&";}}else{ret+=ec(x)+"="+ec(_e[x])+"&";}}}if(ret.length&&ret.charAt(ret.length-1)=="&"){ret=ret.substr(0,ret.length-1);}return ret;};dojo.formToQuery=function(_14){return _d.objectToQuery(_d.formToObject(_14));};dojo.formToJson=function(_15,_16){return _d.toJson(_d.formToObject(_15),_16);};dojo.queryToObject=function(str){var ret={};var qp=str.split("&");var dc=decodeURIComponent;_d.forEach(qp,function(_1b){if(_1b.length){var _1c=_1b.split("=");var _1d=dc(_1c.shift());var val=dc(_1c.join("="));if(_d.isString(ret[_1d])){ret[_1d]=[ret[_1d]];}if(_d.isArray(ret[_1d])){ret[_1d].push(val);}else{ret[_1d]=val;}}});return ret;};dojo._blockAsync=false;dojo._contentHandlers={"text":function(xhr){return xhr.responseText;},"json":function(xhr){if(!djConfig.usePlainJson){console.debug("Consider using mimetype:text/json-comment-filtered"+" to avoid potential security issues with JSON endpoints"+" (use djConfig.usePlainJson=true to turn off this message)");}return _d.fromJson(xhr.responseText);},"json-comment-filtered":function(xhr){var _22=xhr.responseText;var _23=_22.indexOf("/*");var _24=_22.lastIndexOf("*/");if(_23==-1||_24==-1){throw new Error("JSON was not comment filtered");}return _d.fromJson(_22.substring(_23+2,_24));},"javascript":function(xhr){return _d.eval(xhr.responseText);},"xml":function(xhr){if(_d.isIE&&!xhr.responseXML){_d.forEach(["MSXML2","Microsoft","MSXML","MSXML3"],function(i){try{var doc=new ActiveXObject(prefixes[i]+".XMLDOM");doc.async=false;doc.loadXML(xhr.responseText);return doc;}catch(e){}});}else{return xhr.responseXML;}}};dojo._contentHandlers["json-comment-optional"]=function(xhr){var _2a=_d._contentHandlers;try{return _2a["json-comment-filtered"](xhr);}catch(e){return _2a["json"](xhr);}};dojo._ioSetArgs=function(_2b,_2c,_2d,_2e){var _2f={args:_2b,url:_2b.url};var _30=null;if(_2b.form){var _31=_d.byId(_2b.form);var _32=_31.getAttributeNode("action");_2f.url=_2f.url||(_32?_32.value:null);_30=_d.formToObject(_31);}var _33=[{}];if(_30){_33.push(_30);}if(_2b.content){_33.push(_2b.content);}if(_2b.preventCache){_33.push({"dojo.preventCache":new Date().valueOf()});}_2f.query=_d.objectToQuery(_d.mixin.apply(null,_33));_2f.handleAs=_2b.handleAs||"text";var d=new _d.Deferred(_2c);d.addCallbacks(_2d,function(_35){return _2e(_35,d);});var ld=_2b.load;if(ld&&_d.isFunction(ld)){d.addCallback(function(_37){return ld.call(_2b,_37,_2f);});}var err=_2b.error;if(err&&_d.isFunction(err)){d.addErrback(function(_39){return err.call(_2b,_39,_2f);});}var _3a=_2b.handle;if(_3a&&_d.isFunction(_3a)){d.addBoth(function(_3b){return _3a.call(_2b,_3b,_2f);});}d.ioArgs=_2f;return d;};var _3c=function(dfd){dfd.canceled=true;var xhr=dfd.ioArgs.xhr;var _at=(typeof xhr.abort);if((_at=="function")||(_at=="unknown")){xhr.abort();}var err=new Error("xhr cancelled");err.dojoType="cancel";return err;};var _41=function(dfd){return _d._contentHandlers[dfd.ioArgs.handleAs](dfd.ioArgs.xhr);};var _43=function(_44,dfd){console.debug(_44);return _44;};var _46=function(_47){var dfd=_d._ioSetArgs(_47,_3c,_41,_43);dfd.ioArgs.xhr=_d._xhrObj(dfd.ioArgs.args);return dfd;};var _49=null;var _4a=[];var _4b=function(){var now=(new Date()).getTime();if(!_d._blockAsync){for(var i=0,tif;(i<_4a.length)&&(tif=_4a[i]);i++){var dfd=tif.dfd;try{if(!dfd||dfd.canceled||!tif.validCheck(dfd)){_4a.splice(i--,1);}else{if(tif.ioCheck(dfd)){_4a.splice(i--,1);tif.resHandle(dfd);}else{if(dfd.startTime){if(dfd.startTime+(dfd.ioArgs.args.timeout||0)<now){_4a.splice(i--,1);var err=new Error("timeout exceeded");err.dojoType="timeout";dfd.errback(err);dfd.cancel();}}}}}catch(e){console.debug(e);dfd.errback(new Error("_watchInFlightError!"));}}}if(!_4a.length){clearInterval(_49);_49=null;return;}};dojo._ioCancelAll=function(){try{_d.forEach(_4a,function(i){i.dfd.cancel();});}catch(e){}};if(_d.isIE){_d.addOnUnload(_d._ioCancelAll);}_d._ioWatch=function(dfd,_53,_54,_55){if(dfd.ioArgs.args.timeout){dfd.startTime=(new Date()).getTime();}_4a.push({dfd:dfd,validCheck:_53,ioCheck:_54,resHandle:_55});if(!_49){_49=setInterval(_4b,50);}_4b();};var _56="application/x-www-form-urlencoded";var _57=function(dfd){return dfd.ioArgs.xhr.readyState;};var _59=function(dfd){return 4==dfd.ioArgs.xhr.readyState;};var _5b=function(dfd){if(_d._isDocumentOk(dfd.ioArgs.xhr)){dfd.callback(dfd);}else{dfd.errback(new Error("bad http response code:"+dfd.ioArgs.xhr.status));}};var _5d=function(_5e,dfd){var _60=dfd.ioArgs;var _61=_60.args;_60.xhr.open(_5e,_60.url,_61.sync!==true,_61.user||undefined,_61.password||undefined);if(_61.headers){for(var hdr in _61.headers){if(hdr.toLowerCase()==="content-type"&&!_61.contentType){_61.contentType=_61.headers[hdr];}else{_60.xhr.setRequestHeader(hdr,_61.headers[hdr]);}}}_60.xhr.setRequestHeader("Content-Type",(_61.contentType||_56));try{_60.xhr.send(_60.query);}catch(e){dfd.cancel();}_d._ioWatch(dfd,_57,_59,_5b);return dfd;};dojo._ioAddQueryToUrl=function(_63){if(_63.query.length){_63.url+=(_63.url.indexOf("?")==-1?"?":"&")+_63.query;_63.query=null;}};dojo.xhrGet=function(_64){var dfd=_46(_64);_d._ioAddQueryToUrl(dfd.ioArgs);return _5d("GET",dfd);};dojo.xhrPost=function(_66){return _5d("POST",_46(_66));};dojo.rawXhrPost=function(_67){var dfd=_46(_67);dfd.ioArgs.query=_67.postData;return _5d("POST",dfd);};dojo.xhrPut=function(_69){return _5d("PUT",_46(_69));};dojo.rawXhrPut=function(_6a){var dfd=_46(_6a);var _6c=dfd.ioArgs;if(_6a["putData"]){_6c.query=_6a.putData;_6a.putData=null;}return _5d("PUT",dfd);};dojo.xhrDelete=function(_6d){var dfd=_46(_6d);_d._ioAddQueryToUrl(dfd.ioArgs);return _5d("DELETE",dfd);};})();}