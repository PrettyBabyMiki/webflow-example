/*
	Copyright (c) 2004-2007, The Dojo Foundation
	All Rights Reserved.

	Licensed under the Academic Free License version 2.1 or above OR the
	modified BSD license. For more information on Dojo licensing, see:

		http://dojotoolkit.org/book/dojo-book-0-9/introduction/licensing
*/


if(!dojo._hasResource["dojo.data.ItemFileWriteStore"]){dojo._hasResource["dojo.data.ItemFileWriteStore"]=true;dojo.provide("dojo.data.ItemFileWriteStore");dojo.require("dojo.data.ItemFileReadStore");dojo.declare("dojo.data.ItemFileWriteStore",dojo.data.ItemFileReadStore,{constructor:function(_1){this._features["dojo.data.api.Write"]=true;this._features["dojo.data.api.Notification"]=true;this._pending={_newItems:{},_modifiedItems:{},_deletedItems:{}};if(!this._datatypeMap["Date"].serialize){this._datatypeMap["Date"].serialize=function(_2){return dojo.date.stamp.toISOString(_2,{zulu:true});};}this._saveInProgress=false;},_assert:function(_3){if(!_3){throw new Error("assertion failed in ItemFileWriteStore");}},_getIdentifierAttribute:function(){var _4=this.getFeatures()["dojo.data.api.Identity"];return _4;},newItem:function(_5,_6){this._assert(!this._saveInProgress);if(!this._loadFinished){this._forceLoad();}if(typeof _5!="object"&&typeof _5!="undefined"){throw new Error("newItem() was passed something other than an object");}var _7=null;var _8=this._getIdentifierAttribute();if(_8===Number){_7=this._arrayOfAllItems.length;}else{_7=_5[_8];if(typeof _7==="undefined"){throw new Error("newItem() was not passed an identity for the new item");}if(dojo.isArray(_7)){throw new Error("newItem() was not passed an single-valued identity");}}if(this._itemsByIdentity){this._assert(typeof this._itemsByIdentity[_7]==="undefined");}this._assert(typeof this._pending._newItems[_7]==="undefined");this._assert(typeof this._pending._deletedItems[_7]==="undefined");var _9={};_9[this._storeRefPropName]=this;_9[this._itemNumPropName]=this._arrayOfAllItems.length;if(this._itemsByIdentity){this._itemsByIdentity[_7]=_9;}this._arrayOfAllItems.push(_9);var _a=null;if(_6&&_6.parent&&_6.attribute){_a={item:_6.parent,attribute:_6.attribute,oldValue:undefined};var _b=this.getValues(_6.parent,_6.attribute);if(_b&&_b.length>0){var _c=_b.slice(0,_b.length);if(_b.length===1){_a.oldValue=_b[0];}else{_a.oldValue=_b.slice(0,_b.length);}_c.push(_9);this._setValueOrValues(_6.parent,_6.attribute,_c,false);_a.newValue=this.getValues(_6.parent,_6.attribute);}else{this._setValueOrValues(_6.parent,_6.attribute,_9,false);_a.newValue=_9;}}else{_9[this._rootItemPropName]=true;this._arrayOfTopLevelItems.push(_9);}this._pending._newItems[_7]=_9;for(var _d in _5){if(_d===this._storeRefPropName||_d===this._itemNumPropName){throw new Error("encountered bug in ItemFileWriteStore.newItem");}var _e=_5[_d];if(!dojo.isArray(_e)){_e=[_e];}_9[_d]=_e;}this.onNew(_9,_a);return _9;},_removeArrayElement:function(_f,_10){var _11=dojo.indexOf(_f,_10);if(_11!=-1){_f.splice(_11,1);return true;}return false;},deleteItem:function(_12){this._assert(!this._saveInProgress);this._assertIsItem(_12);var _13=_12[this._itemNumPropName];this._arrayOfAllItems[_13]=null;var _14=this.getIdentity(_12);_12[this._storeRefPropName]=null;if(this._itemsByIdentity){delete this._itemsByIdentity[_14];}this._pending._deletedItems[_14]=_12;if(_12[this._rootItemPropName]){this._removeArrayElement(this._arrayOfTopLevelItems,_12);}this.onDelete(_12);return true;},setValue:function(_15,_16,_17){return this._setValueOrValues(_15,_16,_17,true);},setValues:function(_18,_19,_1a){return this._setValueOrValues(_18,_19,_1a,true);},unsetAttribute:function(_1b,_1c){return this._setValueOrValues(_1b,_1c,[],true);},_setValueOrValues:function(_1d,_1e,_1f,_20){this._assert(!this._saveInProgress);this._assertIsItem(_1d);this._assert(dojo.isString(_1e));this._assert(typeof _1f!=="undefined");var _21=this._getIdentifierAttribute();if(_1e==_21){throw new Error("ItemFileWriteStore does not have support for changing the value of an item's identifier.");}var _22=this._getValueOrValues(_1d,_1e);var _23=this.getIdentity(_1d);if(!this._pending._modifiedItems[_23]){var _24={};for(var key in _1d){if((key===this._storeRefPropName)||(key===this._itemNumPropName)||(key===this._rootItemPropName)){_24[key]=_1d[key];}else{var _26=_1d[key];var _27=[];for(var i=0;i<_26.length;++i){_27.push(_26[i]);}_24[key]=_27;}}this._pending._modifiedItems[_23]=_24;}var _29=false;if(dojo.isArray(_1f)&&_1f.length===0){_29=delete _1d[_1e];_1f=undefined;}else{var _2a=[];if(dojo.isArray(_1f)){var _2b=_1f;for(var j=0;j<_2b.length;++j){_2a.push(_2b[j]);}}else{var _2d=_1f;_2a.push(_2d);}_1d[_1e]=_2a;_29=true;}if(_20){this.onSet(_1d,_1e,_22,_1f);}return _29;},_getValueOrValues:function(_2e,_2f){var _30=undefined;if(this.hasAttribute(_2e,_2f)){var _31=this.getValues(_2e,_2f);if(_31.length==1){_30=_31[0];}else{_30=_31;}}return _30;},_flatten:function(_32){if(this.isItem(_32)){var _33=_32;var _34=this.getIdentity(_33);var _35={_reference:_34};return _35;}else{if(typeof _32==="object"){for(type in this._datatypeMap){var _36=this._datatypeMap[type];if(dojo.isObject(_36)&&!dojo.isFunction(_36)){if(_32 instanceof _36.type){if(!_36.serialize){throw new Error("ItemFileWriteStore:  No serializer defined for type mapping: ["+type+"]");}return {_type:type,_value:_36.serialize(_32)};}}else{if(_32 instanceof _36){return {_type:type,_value:_32.toString()};}}}}return _32;}},_getNewFileContentString:function(){var _37={};var _38=this._getIdentifierAttribute();if(_38!==Number){_37.identifier=_38;}if(this._labelAttr){_37.label=this._labelAttr;}_37.items=[];for(var i=0;i<this._arrayOfAllItems.length;++i){var _3a=this._arrayOfAllItems[i];if(_3a!==null){serializableItem={};for(var key in _3a){if(key!==this._storeRefPropName&&key!==this._itemNumPropName){var _3c=key;var _3d=this.getValues(_3a,_3c);if(_3d.length==1){serializableItem[_3c]=this._flatten(_3d[0]);}else{var _3e=[];for(var j=0;j<_3d.length;++j){_3e.push(this._flatten(_3d[j]));serializableItem[_3c]=_3e;}}}}_37.items.push(serializableItem);}}var _40=true;return dojo.toJson(_37,_40);},save:function(_41){this._assert(!this._saveInProgress);this._saveInProgress=true;var _42=this;var _43=function(){_42._pending={_newItems:{},_modifiedItems:{},_deletedItems:{}};_42._saveInProgress=false;if(_41&&_41.onComplete){var _44=_41.scope||dojo.global;_41.onComplete.call(_44);}};var _45=function(){_42._saveInProgress=false;if(_41&&_41.onError){var _46=_41.scope||dojo.global;_41.onError.call(_46);}};if(this._saveEverything){var _47=this._getNewFileContentString();this._saveEverything(_43,_45,_47);}if(this._saveCustom){this._saveCustom(_43,_45);}if(!this._saveEverything&&!this._saveCustom){_43();}},revert:function(){this._assert(!this._saveInProgress);var _48;for(_48 in this._pending._newItems){var _49=this._pending._newItems[_48];_49[this._storeRefPropName]=null;this._arrayOfAllItems[_49[this._itemNumPropName]]=null;if(_49[this._rootItemPropName]){this._removeArrayElement(this._arrayOfTopLevelItems,_49);}if(this._itemsByIdentity){delete this._itemsByIdentity[_48];}}for(_48 in this._pending._modifiedItems){var _4a=this._pending._modifiedItems[_48];var _4b=null;if(this._itemsByIdentity){_4b=this._itemsByIdentity[_48];}else{_4b=this._arrayOfAllItems[_48];}_4a[this._storeRefPropName]=this;_4b[this._storeRefPropName]=null;var _4c=_4b[this._itemNumPropName];this._arrayOfAllItems[_4c]=_4a;if(_4b[this._rootItemPropName]){_4c=_4b[this._itemNumPropName];this._arrayOfTopLevelItems[_4c]=_4a;}if(this._itemsByIdentity){this._itemsByIdentity[_48]=_4a;}}for(_48 in this._pending._deletedItems){var _4d=this._pending._deletedItems[_48];_4d[this._storeRefPropName]=this;var _4e=_4d[this._itemNumPropName];this._arrayOfAllItems[_4e]=_4d;if(this._itemsByIdentity){this._itemsByIdentity[_48]=_4d;}if(_4d[this._rootItemPropName]){this._arrayOfTopLevelItems.push(_4d);}}this._pending={_newItems:{},_modifiedItems:{},_deletedItems:{}};return true;},isDirty:function(_4f){if(_4f){var _50=this.getIdentity(_4f);return new Boolean(this._pending._newItems[_50]||this._pending._modifiedItems[_50]||this._pending._deletedItems[_50]);}else{var key;for(key in this._pending._newItems){return true;}for(key in this._pending._modifiedItems){return true;}for(key in this._pending._deletedItems){return true;}return false;}},onSet:function(_52,_53,_54,_55){},onNew:function(_56,_57){},onDelete:function(_58){}});}