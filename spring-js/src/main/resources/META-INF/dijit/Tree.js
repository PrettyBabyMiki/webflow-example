/*
	Copyright (c) 2004-2007, The Dojo Foundation
	All Rights Reserved.

	Licensed under the Academic Free License version 2.1 or above OR the
	modified BSD license. For more information on Dojo licensing, see:

		http://dojotoolkit.org/book/dojo-book-0-9/introduction/licensing
*/


if(!dojo._hasResource["dijit.Tree"]){dojo._hasResource["dijit.Tree"]=true;dojo.provide("dijit.Tree");dojo.require("dojo.fx");dojo.require("dijit._Widget");dojo.require("dijit._Templated");dojo.require("dijit._Container");dojo.require("dojo.cookie");dojo.declare("dijit._TreeNode",[dijit._Widget,dijit._Templated,dijit._Container,dijit._Contained],{item:null,isTreeNode:true,label:"",isExpandable:null,isExpanded:false,state:"UNCHECKED",templateString:"<div class=\"dijitTreeNode dijitTreeExpandLeaf dijitTreeChildrenNo\" waiRole=\"presentation\"\n\t><span dojoAttachPoint=\"expandoNode\" class=\"dijitTreeExpando\" waiRole=\"presentation\"\n\t></span\n\t><span dojoAttachPoint=\"expandoNodeText\" class=\"dijitExpandoText\" waiRole=\"presentation\"\n\t></span\n\t>\n\t<div dojoAttachPoint=\"contentNode\" class=\"dijitTreeContent\" waiRole=\"presentation\">\n\t\t<div dojoAttachPoint=\"iconNode\" class=\"dijitInline dijitTreeIcon\" waiRole=\"presentation\"></div>\n\t\t<span dojoAttachPoint=\"labelNode\" class=\"dijitTreeLabel\" wairole=\"treeitem\" tabindex=\"-1\"></span>\n\t</div>\n</div>\n",postCreate:function(){this.setLabelNode(this.label);this._setExpando();this._updateItemClasses(this.item);if(this.isExpandable){dijit.setWaiState(this.labelNode,"expanded",this.isExpanded);}},markProcessing:function(){this.state="LOADING";this._setExpando(true);},unmarkProcessing:function(){this._setExpando(false);},_updateItemClasses:function(_1){this.iconNode.className="dijitInline dijitTreeIcon "+this.tree.getIconClass(_1);this.labelNode.className="dijitTreeLabel "+this.tree.getLabelClass(_1);},_updateLayout:function(){var _2=this.getParent();if(_2&&_2.isTree&&_2._hideRoot){dojo.addClass(this.domNode,"dijitTreeIsRoot");}else{dojo.toggleClass(this.domNode,"dijitTreeIsLast",!this.getNextSibling());}},_setExpando:function(_3){var _4=["dijitTreeExpandoLoading","dijitTreeExpandoOpened","dijitTreeExpandoClosed","dijitTreeExpandoLeaf"];var _5=_3?0:(this.isExpandable?(this.isExpanded?1:2):3);dojo.forEach(_4,function(s){dojo.removeClass(this.expandoNode,s);},this);dojo.addClass(this.expandoNode,_4[_5]);this.expandoNodeText.innerHTML=_3?"*":(this.isExpandable?(this.isExpanded?"-":"+"):"*");},expand:function(){if(this.isExpanded){return;}if(this._wipeOut.status()=="playing"){this._wipeOut.stop();}this.isExpanded=true;dijit.setWaiState(this.labelNode,"expanded","true");dijit.setWaiRole(this.containerNode,"group");this._setExpando();this._wipeIn.play();},collapse:function(){if(!this.isExpanded){return;}if(this._wipeIn.status()=="playing"){this._wipeIn.stop();}this.isExpanded=false;dijit.setWaiState(this.labelNode,"expanded","false");this._setExpando();this._wipeOut.play();},setLabelNode:function(_7){this.labelNode.innerHTML="";this.labelNode.appendChild(document.createTextNode(_7));},_setChildren:function(_8){this.destroyDescendants();this.state="LOADED";var _9={};if(_8&&_8.length>0){this.isExpandable=true;if(!this.containerNode){this.containerNode=this.tree.containerNodeTemplate.cloneNode(true);this.domNode.appendChild(this.containerNode);}dojo.forEach(_8,function(_a){var _b=new dijit._TreeNode(dojo.mixin({tree:this.tree,label:this.tree.getLabel(_a.item)},_a));this.addChild(_b);var _c=this.tree.store.getIdentity(_a.item);_9[_c]=_b;if(this.tree.persist){if(this.tree._openedItemIds[_c]){this.tree._expandNode(_b);}}},this);dojo.forEach(this.getChildren(),function(_d,_e){_d._updateLayout();});}else{this.isExpandable=false;}if(this._setExpando){this._setExpando(false);}if(this.isTree&&this._hideRoot){var fc=this.getChildren()[0];var _10=fc?fc.labelNode:this.domNode;_10.setAttribute("tabIndex","0");}if(this.containerNode&&!this._wipeIn){this._wipeIn=dojo.fx.wipeIn({node:this.containerNode,duration:150});this._wipeOut=dojo.fx.wipeOut({node:this.containerNode,duration:150});}return _9;},_addChildren:function(_11){var _12={};if(_11&&_11.length>0){dojo.forEach(_11,function(_13){var _14=new dijit._TreeNode(dojo.mixin({tree:this.tree,label:this.tree.getLabel(_13.item)},_13));this.addChild(_14);_12[this.tree.store.getIdentity(_13.item)]=_14;},this);dojo.forEach(this.getChildren(),function(_15,idx){_15._updateLayout();});}return _12;},deleteNode:function(_17){_17.destroy();var _18=this.getChildren();if(_18.length==0){this.isExpandable=false;this.collapse();}dojo.forEach(_18,function(_19){_19._updateLayout();});},makeExpandable:function(){this.isExpandable=true;this._setExpando(false);}});dojo.declare("dijit.Tree",dijit._TreeNode,{store:null,query:null,childrenAttr:["children"],templateString:"<div class=\"dijitTreeContainer\" style=\"\" waiRole=\"tree\"\n\tdojoAttachEvent=\"onclick:_onClick,onkeypress:_onKeyPress\">\n\t<div class=\"dijitTreeNode  dijitTreeIsRoot dijitTreeExpandLeaf dijitTreeChildrenNo\" waiRole=\"presentation\"\n\t\tdojoAttachPoint=\"rowNode\"\n\t\t><span dojoAttachPoint=\"expandoNode\" class=\"dijitTreeExpando\" waiRole=\"presentation\"\n\t\t></span\n\t\t><span dojoAttachPoint=\"expandoNodeText\" class=\"dijitExpandoText\" waiRole=\"presentation\"\n\t\t></span\n\t\t>\n\t\t<div dojoAttachPoint=\"contentNode\" class=\"dijitTreeContent\" waiRole=\"presentation\">\n\t\t\t<div dojoAttachPoint=\"iconNode\" class=\"dijitInline dijitTreeIcon\" waiRole=\"presentation\"></div>\n\t\t\t<span dojoAttachPoint=\"labelNode\" class=\"dijitTreeLabel\" wairole=\"treeitem\" tabindex=\"0\"></span>\n\t\t</div>\n\t</div>\n</div>\n",isExpandable:true,isTree:true,persist:true,dndController:null,dndParams:["onDndDrop","itemCreator","onDndCancel","checkAcceptance","checkItemAcceptance"],onDndDrop:null,itemCreator:null,onDndCancel:null,checkAcceptance:null,checkItemAcceptance:null,_publish:function(_1a,_1b){dojo.publish(this.id,[dojo.mixin({tree:this,event:_1a},_1b||{})]);},postMixInProperties:function(){this.tree=this;this.lastFocused=this.labelNode;this._itemNodeMap={};this._hideRoot=!this.label;if(!this.store.getFeatures()["dojo.data.api.Identity"]){throw new Error("dijit.tree requires access to a store supporting the dojo.data Identity api");}if(!this.cookieName){this.cookieName=this.id+"SaveStateCookie";}if(this.store.getFeatures()["dojo.data.api.Notification"]){this.connect(this.store,"onNew","_onNewItem");this.connect(this.store,"onDelete","_onDeleteItem");this.connect(this.store,"onSet","_onSetItem");}},postCreate:function(){if(this.persist){var _1c=dojo.cookie(this.cookieName);this._openedItemIds={};if(_1c){dojo.forEach(_1c.split(","),function(_1d){this._openedItemIds[_1d]=true;},this);}}var div=document.createElement("div");div.style.display="none";div.className="dijitTreeContainer";dijit.setWaiRole(div,"presentation");this.containerNodeTemplate=div;if(this._hideRoot){this.rowNode.style.display="none";}this.inherited("postCreate",arguments);this._expandNode(this);if(this.dndController){if(dojo.isString(this.dndController)){this.dndController=dojo.getObject(this.dndController);}var _1f={};for(var i=0;i<this.dndParams.length;i++){if(this[this.dndParams[i]]){_1f[this.dndParams[i]]=this[this.dndParams[i]];}}this.dndController=new this.dndController(this,_1f);}this.connect(this.domNode,dojo.isIE?"onactivate":"onfocus","_onTreeFocus");},mayHaveChildren:function(_21){return dojo.some(this.childrenAttr,function(_22){return this.store.hasAttribute(_21,_22);},this);},getItemChildren:function(_23,_24){var _25=this.store;if(_23==null){_25.fetch({query:this.query,onComplete:_24});}else{var _26=[];for(var i=0;i<this.childrenAttr.length;i++){_26=_26.concat(_25.getValues(_23,this.childrenAttr[i]));}var _28=0;dojo.forEach(_26,function(_29){if(!_25.isItemLoaded(_29)){_28++;}});if(_28==0){_24(_26);}else{function onItem(_2a){if(--_28==0){_24(_26);}};dojo.forEach(_26,function(_2b){if(!_25.isItemLoaded(_2b)){_25.loadItem({item:_2b,onItem:onItem});}});}}},getItemParentIdentity:function(_2c,_2d){return this.store.getIdentity(_2d.item);},getLabel:function(_2e){return this.store.getLabel(_2e);},getIconClass:function(_2f){},getLabelClass:function(_30){},_onLoadAllItems:function(_31,_32){var _33=dojo.map(_32,function(_34){return {item:_34,isExpandable:this.mayHaveChildren(_34)};},this);dojo.mixin(this._itemNodeMap,_31._setChildren(_33));this._expandNode(_31);},_onKeyPress:function(e){if(e.altKey){return;}var _36=dijit.getEnclosingWidget(e.target);if(!_36){return;}if(e.charCode){var _37=e.charCode;if(!e.altKey&&!e.ctrlKey&&!e.shiftKey&&!e.metaKey){_37=(String.fromCharCode(_37)).toLowerCase();this._onLetterKeyNav({node:_36,key:_37});dojo.stopEvent(e);}}else{var map=this._keyHandlerMap;if(!map){map={};map[dojo.keys.ENTER]="_onEnterKey";map[dojo.keys.LEFT_ARROW]="_onLeftArrow";map[dojo.keys.RIGHT_ARROW]="_onRightArrow";map[dojo.keys.UP_ARROW]="_onUpArrow";map[dojo.keys.DOWN_ARROW]="_onDownArrow";map[dojo.keys.HOME]="_onHomeKey";map[dojo.keys.END]="_onEndKey";this._keyHandlerMap=map;}if(this._keyHandlerMap[e.keyCode]){this[this._keyHandlerMap[e.keyCode]]({node:_36,item:_36.item});dojo.stopEvent(e);}}},_onEnterKey:function(_39){this._publish("execute",{item:_39.item,node:_39.node});this.onClick(_39.item,_39.node);},_onDownArrow:function(_3a){var _3b=this._navToNextNode(_3a.node);if(_3b&&_3b.isTreeNode){_3b.tree.focusNode(_3b);return _3b;}},_onUpArrow:function(_3c){var _3d=_3c.node;var _3e=_3d;var _3f=_3d.getPreviousSibling();if(_3f){_3d=_3f;while(_3d.isExpandable&&_3d.isExpanded&&_3d.hasChildren()){_3e=_3d;var _40=_3d.getChildren();_3d=_40[_40.length-1];}}else{var _41=_3d.getParent();if(!(this._hideRoot&&_41===this)){_3d=_41;}}if(_3d&&_3d.isTreeNode){_3e=_3d;}if(_3e&&_3e.isTreeNode){_3e.tree.focusNode(_3e);return _3e;}},_onRightArrow:function(_42){var _43=_42.node;var _44=_43;if(_43.isExpandable&&!_43.isExpanded){this._expandNode(_43);}else{if(_43.hasChildren()){_43=_43.getChildren()[0];}}if(_43&&_43.isTreeNode){_44=_43;}if(_44&&_44.isTreeNode){_44.tree.focusNode(_44);return _44;}},_onLeftArrow:function(_45){var _46=_45.node;var _47=_46;if(_46.isExpandable&&_46.isExpanded){this._collapseNode(_46);}else{_46=_46.getParent();}if(_46&&_46.isTreeNode){_47=_46;}if(_47&&_47.isTreeNode){_47.tree.focusNode(_47);return _47;}},_onHomeKey:function(){var _48=this._navToRootOrFirstNode();if(_48){_48.tree.focusNode(_48);return _48;}},_onEndKey:function(_49){var _4a=_49.node.tree;var _4b=_4a;while(_4b.isExpanded){var c=_4b.getChildren();_4b=c[c.length-1];if(_4b.isTreeNode){_4a=_4b;}}if(_4a&&_4a.isTreeNode){_4a.tree.focusNode(_4a);return _4a;}},_onLetterKeyNav:function(_4d){var _4e=startNode=_4d.node;var key=_4d.key;do{_4e=this._navToNextNode(_4e);if(!_4e){_4e=this._navToRootOrFirstNode();}}while(_4e!==startNode&&(_4e.label.charAt(0).toLowerCase()!=key));if(_4e&&_4e.isTreeNode){if(_4e!==startNode){_4e.tree.focusNode(_4e);}return _4e;}},_onClick:function(e){var _51=e.target;var _52=dijit.getEnclosingWidget(_51);if(!_52||!_52.isTreeNode){return;}if(_51==_52.expandoNode||_51==_52.expandoNodeText){if(_52.isExpandable){this._onExpandoClick({node:_52});}}else{this._publish("execute",{item:_52.item,node:_52});this.onClick(_52.item,_52);this.focusNode(_52);}dojo.stopEvent(e);},_onExpandoClick:function(_53){var _54=_53.node;if(_54.isExpanded){this._collapseNode(_54);}else{this._expandNode(_54);}},onClick:function(_55,_56){},_navToNextNode:function(_57){var _58;if(_57.isExpandable&&_57.isExpanded&&_57.hasChildren()){_58=_57.getChildren()[0];}else{while(_57&&_57.isTreeNode){_58=_57.getNextSibling();if(_58){break;}_57=_57.getParent();}}return _58;},_navToRootOrFirstNode:function(){if(!this._hideRoot){return this;}else{var _59=this.getChildren()[0];if(_59&&_59.isTreeNode){return _59;}}},_collapseNode:function(_5a){if(_5a.isExpandable){if(_5a.state=="LOADING"){return;}if(this.lastFocused){if(dojo.isDescendant(this.lastFocused.domNode,_5a.domNode)){this.focusNode(_5a);}else{this.focusNode(this.lastFocused);}}_5a.collapse();if(this.persist&&_5a.item){delete this._openedItemIds[this.store.getIdentity(_5a.item)];this._saveState();}}},_expandNode:function(_5b){var t=_5b.tree;if(t.lastFocused){t.focusNode(t.lastFocused);}if(!_5b.isExpandable){return;}var _5d=this.store;var _5e=this.store.getValue;switch(_5b.state){case "LOADING":return;case "UNCHECKED":_5b.markProcessing();var _5f=this;var _60=function(_61){_5b.unmarkProcessing();_5f._onLoadAllItems(_5b,_61);};this.getItemChildren(_5b.item,_60);break;default:if(_5b.expand){_5b.expand();if(this.persist&&_5b.item){this._openedItemIds[this.store.getIdentity(_5b.item)]=true;this._saveState();}}break;}},blurNode:function(){var _62=this.lastFocused;if(!_62){return;}var _63=_62.labelNode;dojo.removeClass(_63,"dijitTreeLabelFocused");_63.setAttribute("tabIndex","-1");this.lastFocused=null;},focusNode:function(_64){_64.labelNode.focus();},_onBlur:function(){if(this.lastFocused){var _65=this.lastFocused.labelNode;dojo.removeClass(_65,"dijitTreeLabelFocused");}},_onTreeFocus:function(evt){var _67=dijit.getEnclosingWidget(evt.target);if(_67!=this.lastFocused){this.blurNode();}var _68=_67.labelNode;_68.setAttribute("tabIndex","0");dojo.addClass(_68,"dijitTreeLabelFocused");this.lastFocused=_67;},_onNewItem:function(_69,_6a){var _6b;if(_6a){var _6c=this._itemNodeMap[this.getItemParentIdentity(_69,_6a)];if(!_6c||dojo.indexOf(this.childrenAttr,_6a.attribute)==-1){return;}}var _6d={item:_69,isExpandable:this.mayHaveChildren(_69)};if(_6c){if(!_6c.isExpandable){_6c.makeExpandable();}if(_6c.state=="LOADED"||_6c.isExpanded){var _6e=_6c._addChildren([_6d]);}}else{var _6e=this._addChildren([_6d]);}if(_6e){dojo.mixin(this._itemNodeMap,_6e);}},_onDeleteItem:function(_6f){var _70=this.store.getIdentity(_6f);var _71=this._itemNodeMap[_70];if(_71){var _72=_71.getParent();_72.deleteNode(_71);this._itemNodeMap[_70]=null;}},_onSetItem:function(_73){var _74=this.store.getIdentity(_73);node=this._itemNodeMap[_74];if(node){node.setLabelNode(this.getLabel(_73));node._updateItemClasses(_73);}},_saveState:function(){if(!this.persist){return;}var ary=[];for(var id in this._openedItemIds){ary.push(id);}dojo.cookie(this.cookieName,ary.join(","));}});}