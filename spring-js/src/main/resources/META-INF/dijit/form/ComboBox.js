/*
	Copyright (c) 2004-2007, The Dojo Foundation
	All Rights Reserved.

	Licensed under the Academic Free License version 2.1 or above OR the
	modified BSD license. For more information on Dojo licensing, see:

		http://dojotoolkit.org/book/dojo-book-0-9/introduction/licensing
*/


if(!dojo._hasResource["dijit.form.ComboBox"]){dojo._hasResource["dijit.form.ComboBox"]=true;dojo.provide("dijit.form.ComboBox");dojo.require("dojo.data.ItemFileReadStore");dojo.require("dijit.form.ValidationTextBox");dojo.requireLocalization("dijit.form","ComboBox",null,"ROOT,cs,de,es,fr,hu,it,ja,ko,pl,pt,ru,zh,zh-tw");dojo.declare("dijit.form.ComboBoxMixin",null,{item:null,pageSize:Infinity,store:null,query:{},autoComplete:true,searchDelay:100,searchAttr:"name",ignoreCase:true,hasDownArrow:true,_hasFocus:false,templateString:"<table class=\"dijit dijitReset dijitInlineTable dijitLeft\" cellspacing=\"0\" cellpadding=\"0\"\n\tid=\"widget_${id}\" name=\"${name}\" dojoAttachEvent=\"onmouseenter:_onMouse,onmouseleave:_onMouse\" waiRole=\"presentation\"\n\t><tr class=\"dijitReset\"\n\t\t><td class='dijitReset dijitStretch dijitInputField' width=\"100%\"\n\t\t\t><input type=\"text\" autocomplete=\"off\" name=\"${name}\"\n\t\t\tdojoAttachEvent=\"onkeypress, onkeyup, onfocus, compositionend\"\n\t\t\tdojoAttachPoint=\"textbox,focusNode\" waiRole=\"combobox\"\n\t\t/></td\n\t\t><td class=\"dijitReset dijitValidationIconField\" width=\"0%\"\n\t\t\t><div dojoAttachPoint='iconNode' class='dijitValidationIcon'></div\n\t\t\t><div class='dijitValidationIconText'>&Chi;</div\n\t\t></td\n\t\t><td class='dijitReset dijitRight dijitButtonNode dijitDownArrowButton' width=\"0%\"\n\t\t\tdojoAttachPoint=\"downArrowNode\"\n\t\t\tdojoAttachEvent=\"onmousedown:_onArrowMouseDown,onmouseup:_onMouse,onmouseenter:_onMouse,onmouseleave:_onMouse\"\n\t\t\t><div class=\"dijitDownArrowButtonInner\" waiRole=\"presentation\"\n\t\t\t\t><div class=\"dijitDownArrowButtonChar\">&#9660;</div\n\t\t\t></div\n\t\t></td\t\n\t></tr\n></table>\n",baseClass:"dijitComboBox",_lastDisplayedValue:"",getValue:function(){return dijit.form.TextBox.superclass.getValue.apply(this,arguments);},setDisplayedValue:function(_1){this._lastDisplayedValue=_1;this.setValue(_1,true);},_getCaretPos:function(_2){if(typeof (_2.selectionStart)=="number"){return _2.selectionStart;}else{if(dojo.isIE){var tr=document.selection.createRange().duplicate();var _4=_2.createTextRange();tr.move("character",0);_4.move("character",0);try{_4.setEndPoint("EndToEnd",tr);return String(_4.text).replace(/\r/g,"").length;}catch(e){return 0;}}}},_setCaretPos:function(_5,_6){_6=parseInt(_6);this._setSelectedRange(_5,_6,_6);},_setSelectedRange:function(_7,_8,_9){if(!_9){_9=_7.value.length;}if(_7.setSelectionRange){dijit.focus(_7);_7.setSelectionRange(_8,_9);}else{if(_7.createTextRange){var _a=_7.createTextRange();with(_a){collapse(true);moveEnd("character",_9);moveStart("character",_8);select();}}else{_7.value=_7.value;_7.blur();dijit.focus(_7);var _b=parseInt(_7.value.length)-_9;var _c=String.fromCharCode(37);var _d=_c.charCodeAt(0);for(var x=0;x<_b;x++){var te=document.createEvent("KeyEvents");te.initKeyEvent("keypress",true,true,null,false,false,false,false,_d,_d);_7.dispatchEvent(te);}}}},onkeypress:function(evt){if(evt.altKey||(evt.ctrlKey&&evt.charCode!=118)){return;}var _11=false;this.item=null;if(this._isShowingNow){this._popupWidget.handleKey(evt);}switch(evt.keyCode){case dojo.keys.PAGE_DOWN:case dojo.keys.DOWN_ARROW:if(!this._isShowingNow||this._prev_key_esc){this._arrowPressed();_11=true;}else{this._announceOption(this._popupWidget.getHighlightedOption());}dojo.stopEvent(evt);this._prev_key_backspace=false;this._prev_key_esc=false;break;case dojo.keys.PAGE_UP:case dojo.keys.UP_ARROW:if(this._isShowingNow){this._announceOption(this._popupWidget.getHighlightedOption());}dojo.stopEvent(evt);this._prev_key_backspace=false;this._prev_key_esc=false;break;case dojo.keys.ENTER:var _12;if(this._isShowingNow&&(_12=this._popupWidget.getHighlightedOption())){if(_12==this._popupWidget.nextButton){this._nextSearch(1);dojo.stopEvent(evt);break;}else{if(_12==this._popupWidget.previousButton){this._nextSearch(-1);dojo.stopEvent(evt);break;}}}else{this.setDisplayedValue(this.getDisplayedValue());}evt.preventDefault();case dojo.keys.TAB:var _13=this.getDisplayedValue();if(this._popupWidget&&(_13==this._popupWidget._messages["previousMessage"]||_13==this._popupWidget._messages["nextMessage"])){break;}if(this._isShowingNow){this._prev_key_backspace=false;this._prev_key_esc=false;if(this._popupWidget.getHighlightedOption()){this._popupWidget.setValue({target:this._popupWidget.getHighlightedOption()},true);}this._hideResultList();}break;case dojo.keys.SPACE:this._prev_key_backspace=false;this._prev_key_esc=false;if(this._isShowingNow&&this._popupWidget.getHighlightedOption()){dojo.stopEvent(evt);this._selectOption();this._hideResultList();}else{_11=true;}break;case dojo.keys.ESCAPE:this._prev_key_backspace=false;this._prev_key_esc=true;this._hideResultList();if(this._lastDisplayedValue!=this.getDisplayedValue()){this.setDisplayedValue(this._lastDisplayedValue);dojo.stopEvent(evt);}else{this.setValue(this.getValue(),false);}break;case dojo.keys.DELETE:case dojo.keys.BACKSPACE:this._prev_key_esc=false;this._prev_key_backspace=true;_11=true;break;case dojo.keys.RIGHT_ARROW:case dojo.keys.LEFT_ARROW:this._prev_key_backspace=false;this._prev_key_esc=false;break;default:this._prev_key_backspace=false;this._prev_key_esc=false;if(dojo.isIE||evt.charCode!=0){_11=true;}}if(this.searchTimer){clearTimeout(this.searchTimer);}if(_11){this.searchTimer=setTimeout(dojo.hitch(this,this._startSearchFromInput),this.searchDelay);}},_autoCompleteText:function(_14){this._setSelectedRange(this.focusNode,this.focusNode.value.length,this.focusNode.value.length);if(new RegExp("^"+escape(this.focusNode.value),this.ignoreCase?"i":"").test(escape(_14))){var _15=this._getCaretPos(this.focusNode);if((_15+1)>this.focusNode.value.length){this.focusNode.value=_14;this._setSelectedRange(this.focusNode,_15,this.focusNode.value.length);dijit.setWaiState(this.focusNode,"valuenow",_14);}}else{this.focusNode.value=_14;this._setSelectedRange(this.focusNode,0,this.focusNode.value.length);dijit.setWaiState(this.focusNode,"valuenow",_14);}},_openResultList:function(_16,_17){if(this.disabled||_17.query[this.searchAttr]!=this._lastQuery){return;}this._popupWidget.clearResultList();if(!_16.length){this._hideResultList();return;}var _18=new String(this.store.getValue(_16[0],this.searchAttr));if(_18&&this.autoComplete&&!this._prev_key_backspace&&(_17.query[this.searchAttr]!="*")){this._autoCompleteText(_18);dijit.setWaiState(this.focusNode||this.domNode,"valuenow",_18);}this._popupWidget.createOptions(_16,_17,dojo.hitch(this,this._getMenuLabelFromItem));this._showResultList();if(_17.direction){if(_17.direction==1){this._popupWidget.highlightFirstOption();}else{if(_17.direction==-1){this._popupWidget.highlightLastOption();}}this._announceOption(this._popupWidget.getHighlightedOption());}},_showResultList:function(){this._hideResultList();var _19=this._popupWidget.getItems(),_1a=Math.min(_19.length,this.maxListLength);this._arrowPressed();this._displayMessage("");with(this._popupWidget.domNode.style){width="";height="";}var _1b=this.open();var _1c=dojo.marginBox(this._popupWidget.domNode);this._popupWidget.domNode.style.overflow=((_1b.h==_1c.h)&&(_1b.w==_1c.w))?"hidden":"auto";var _1d=_1b.w;if(_1b.h<this._popupWidget.domNode.scrollHeight){_1d+=16;}dojo.marginBox(this._popupWidget.domNode,{h:_1b.h,w:Math.max(_1d,this.domNode.offsetWidth)});},_hideResultList:function(){if(this._isShowingNow){dijit.popup.close(this._popupWidget);this._arrowIdle();this._isShowingNow=false;}},_onBlur:function(){this._hasFocus=false;this._hasBeenBlurred=true;this._hideResultList();this._arrowIdle();var _1e=this.getDisplayedValue();if(this._popupWidget&&(_1e==this._popupWidget._messages["previousMessage"]||_1e==this._popupWidget._messages["nextMessage"])){this.setValue(this._lastValueReported,true);}else{this.setDisplayedValue(_1e);}},onfocus:function(evt){this._hasFocus=true;this._onMouse(evt);},_announceOption:function(_20){if(_20==null){return;}var _21;if(_20==this._popupWidget.nextButton||_20==this._popupWidget.previousButton){_21=_20.innerHTML;}else{_21=this.store.getValue(_20.item,this.searchAttr);}this.focusNode.value=this.focusNode.value.substring(0,this._getCaretPos(this.focusNode));this._autoCompleteText(_21);},_selectOption:function(evt){var tgt=null;if(!evt){evt={target:this._popupWidget.getHighlightedOption()};}if(!evt.target){this.setDisplayedValue(this.getDisplayedValue());return;}else{tgt=evt.target;}if(!evt.noHide){this._hideResultList();this._setCaretPos(this.focusNode,this.store.getValue(tgt.item,this.searchAttr).length);}this._doSelect(tgt);},_doSelect:function(tgt){this.item=tgt.item;this.setValue(this.store.getValue(tgt.item,this.searchAttr),true);},_onArrowMouseDown:function(evt){if(this.disabled){return;}dojo.stopEvent(evt);this.focus();if(this._isShowingNow){this._hideResultList();}else{this._startSearch("");}},_startSearchFromInput:function(){this._startSearch(this.focusNode.value);},_startSearch:function(key){if(!this._popupWidget){this._popupWidget=new dijit.form._ComboBoxMenu({onChange:dojo.hitch(this,this._selectOption)});}var _27=this.query;this._lastQuery=_27[this.searchAttr]=key+"*";var _28=this.store.fetch({queryOptions:{ignoreCase:this.ignoreCase,deep:true},query:_27,onComplete:dojo.hitch(this,"_openResultList"),start:0,count:this.pageSize});function nextSearch(_29,_2a){_29.start+=_29.count*_2a;_29.direction=_2a;_29.store.fetch(_29);};this._nextSearch=this._popupWidget.onPage=dojo.hitch(this,nextSearch,_28);},_getValueField:function(){return this.searchAttr;},_arrowPressed:function(){if(!this.disabled&&this.hasDownArrow){dojo.addClass(this.downArrowNode,"dijitArrowButtonActive");}},_arrowIdle:function(){if(!this.disabled&&this.hasDownArrow){dojo.removeClass(this.downArrowNode,"dojoArrowButtonPushed");}},compositionend:function(evt){this.onkeypress({charCode:-1});},constructor:function(){this.query={};},postMixInProperties:function(){if(!this.hasDownArrow){this.baseClass="dijitTextBox";}if(!this.store){var _2c=this.srcNodeRef?dojo.query("> option",this.srcNodeRef).map(function(_2d){_2d.style.display="none";return {value:_2d.getAttribute("value"),name:String(_2d.innerHTML)};}):{};this.store=new dojo.data.ItemFileReadStore({data:{identifier:this._getValueField(),items:_2c}});if(_2c&&_2c.length&&!this.value){this.value=_2c[this.srcNodeRef.selectedIndex!=-1?this.srcNodeRef.selectedIndex:0][this._getValueField()];}}},uninitialize:function(){if(this._popupWidget){this._hideResultList();this._popupWidget.destroy();}},_getMenuLabelFromItem:function(_2e){return {html:false,label:this.store.getValue(_2e,this.searchAttr)};},open:function(){this._isShowingNow=true;return dijit.popup.open({popup:this._popupWidget,around:this.domNode,parent:this});}});dojo.declare("dijit.form._ComboBoxMenu",[dijit._Widget,dijit._Templated],{templateString:"<div class='dijitMenu' dojoAttachEvent='onmousedown,onmouseup,onmouseover,onmouseout' tabIndex='-1' style='overflow:\"auto\";'>"+"<div class='dijitMenuItem dijitMenuPreviousButton' dojoAttachPoint='previousButton'></div>"+"<div class='dijitMenuItem dijitMenuNextButton' dojoAttachPoint='nextButton'></div>"+"</div>",_messages:null,postMixInProperties:function(){this._messages=dojo.i18n.getLocalization("dijit.form","ComboBox",this.lang);this.inherited("postMixInProperties",arguments);},setValue:function(_2f){this.value=_2f;this.onChange(_2f);},onChange:function(_30){},onPage:function(_31){},postCreate:function(){this.previousButton.innerHTML=this._messages["previousMessage"];this.nextButton.innerHTML=this._messages["nextMessage"];this.inherited("postCreate",arguments);},onClose:function(){this._blurOptionNode();},_createOption:function(_32,_33){var _34=_33(_32);var _35=document.createElement("div");if(_34.html){_35.innerHTML=_34.label;}else{_35.appendChild(document.createTextNode(_34.label));}if(_35.innerHTML==""){_35.innerHTML="&nbsp;";}_35.item=_32;return _35;},createOptions:function(_36,_37,_38){this.previousButton.style.display=_37.start==0?"none":"";var _39=this;dojo.forEach(_36,function(_3a){var _3b=_39._createOption(_3a,_38);_3b.className="dijitMenuItem";_39.domNode.insertBefore(_3b,_39.nextButton);});this.nextButton.style.display=_37.count==_36.length?"":"none";},clearResultList:function(){while(this.domNode.childNodes.length>2){this.domNode.removeChild(this.domNode.childNodes[this.domNode.childNodes.length-2]);}},getItems:function(){return this.domNode.childNodes;},getListLength:function(){return this.domNode.childNodes.length-2;},onmousedown:function(evt){dojo.stopEvent(evt);},onmouseup:function(evt){if(evt.target===this.domNode){return;}else{if(evt.target==this.previousButton){this.onPage(-1);}else{if(evt.target==this.nextButton){this.onPage(1);}else{var tgt=evt.target;while(!tgt.item){tgt=tgt.parentNode;}this.setValue({target:tgt},true);}}}},onmouseover:function(evt){if(evt.target===this.domNode){return;}var tgt=evt.target;if(!(tgt==this.previousButton||tgt==this.nextButton)){while(!tgt.item){tgt=tgt.parentNode;}}this._focusOptionNode(tgt);},onmouseout:function(evt){if(evt.target===this.domNode){return;}this._blurOptionNode();},_focusOptionNode:function(_42){if(this._highlighted_option!=_42){this._blurOptionNode();this._highlighted_option=_42;dojo.addClass(this._highlighted_option,"dijitMenuItemHover");}},_blurOptionNode:function(){if(this._highlighted_option){dojo.removeClass(this._highlighted_option,"dijitMenuItemHover");this._highlighted_option=null;}},_highlightNextOption:function(){if(!this.getHighlightedOption()){this._focusOptionNode(this.domNode.firstChild.style.display=="none"?this.domNode.firstChild.nextSibling:this.domNode.firstChild);}else{if(this._highlighted_option.nextSibling&&this._highlighted_option.nextSibling.style.display!="none"){this._focusOptionNode(this._highlighted_option.nextSibling);}}dijit.scrollIntoView(this._highlighted_option);},highlightFirstOption:function(){this._focusOptionNode(this.domNode.firstChild.nextSibling);dijit.scrollIntoView(this._highlighted_option);},highlightLastOption:function(){this._focusOptionNode(this.domNode.lastChild.previousSibling);dijit.scrollIntoView(this._highlighted_option);},_highlightPrevOption:function(){if(!this.getHighlightedOption()){this._focusOptionNode(this.domNode.lastChild.style.display=="none"?this.domNode.lastChild.previousSibling:this.domNode.lastChild);}else{if(this._highlighted_option.previousSibling&&this._highlighted_option.previousSibling.style.display!="none"){this._focusOptionNode(this._highlighted_option.previousSibling);}}dijit.scrollIntoView(this._highlighted_option);},_page:function(up){var _44=0;var _45=this.domNode.scrollTop;var _46=parseInt(dojo.getComputedStyle(this.domNode).height);if(!this.getHighlightedOption()){this._highlightNextOption();}while(_44<_46){if(up){if(!this.getHighlightedOption().previousSibling||this._highlighted_option.previousSibling.style.display=="none"){break;}this._highlightPrevOption();}else{if(!this.getHighlightedOption().nextSibling||this._highlighted_option.nextSibling.style.display=="none"){break;}this._highlightNextOption();}var _47=this.domNode.scrollTop;_44+=(_47-_45)*(up?-1:1);_45=_47;}},pageUp:function(){this._page(true);},pageDown:function(){this._page(false);},getHighlightedOption:function(){return this._highlighted_option&&this._highlighted_option.parentNode?this._highlighted_option:null;},handleKey:function(evt){switch(evt.keyCode){case dojo.keys.DOWN_ARROW:this._highlightNextOption();break;case dojo.keys.PAGE_DOWN:this.pageDown();break;case dojo.keys.UP_ARROW:this._highlightPrevOption();break;case dojo.keys.PAGE_UP:this.pageUp();break;}}});dojo.declare("dijit.form.ComboBox",[dijit.form.ValidationTextBox,dijit.form.ComboBoxMixin],{postMixInProperties:function(){dijit.form.ComboBoxMixin.prototype.postMixInProperties.apply(this,arguments);dijit.form.ValidationTextBox.prototype.postMixInProperties.apply(this,arguments);}});}