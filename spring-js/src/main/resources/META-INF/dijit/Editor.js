/*
	Copyright (c) 2004-2007, The Dojo Foundation
	All Rights Reserved.

	Licensed under the Academic Free License version 2.1 or above OR the
	modified BSD license. For more information on Dojo licensing, see:

		http://dojotoolkit.org/book/dojo-book-0-9/introduction/licensing
*/


if(!dojo._hasResource["dijit.Editor"]){dojo._hasResource["dijit.Editor"]=true;dojo.provide("dijit.Editor");dojo.require("dijit._editor.RichText");dojo.require("dijit.Toolbar");dojo.require("dijit._editor._Plugin");dojo.require("dijit._Container");dojo.require("dojo.i18n");dojo.requireLocalization("dijit._editor","commands",null,"ROOT,cs,de,es,fr,hu,it,ja,ko,pl,pt,ru,zh,zh-tw");dojo.declare("dijit.Editor",dijit._editor.RichText,{plugins:null,extraPlugins:null,constructor:function(){this.plugins=["undo","redo","|","cut","copy","paste","|","bold","italic","underline","strikethrough","|","insertOrderedList","insertUnorderedList","indent","outdent","|","justifyLeft","justifyRight","justifyCenter","justifyFull"];this._plugins=[];this._editInterval=this.editActionInterval*1000;},postCreate:function(){if(this.customUndo){dojo["require"]("dijit._editor.range");this._steps=this._steps.slice(0);this._undoedSteps=this._undoedSteps.slice(0);}if(dojo.isArray(this.extraPlugins)){this.plugins=this.plugins.concat(this.extraPlugins);}dijit.Editor.superclass.postCreate.apply(this,arguments);this.commands=dojo.i18n.getLocalization("dijit._editor","commands",this.lang);if(!this.toolbar){var _1=dojo.doc.createElement("div");dojo.place(_1,this.editingArea,"before");this.toolbar=new dijit.Toolbar({},_1);}dojo.forEach(this.plugins,this.addPlugin,this);this.onNormalizedDisplayChanged();},destroy:function(){dojo.forEach(this._plugins,function(p){if(p.destroy){p.destroy();}});this._plugins=[];this.toolbar.destroy();delete this.toolbar;this.inherited("destroy",arguments);},addPlugin:function(_3,_4){var _5=dojo.isString(_3)?{name:_3}:_3;if(!_5.setEditor){var o={"args":_5,"plugin":null,"editor":this};dojo.publish("dijit.Editor.getPlugin",[o]);if(!o.plugin){var pc=dojo.getObject(_5.name);if(pc){o.plugin=new pc(_5);}}if(!o.plugin){console.debug("Cannot find plugin",_3);return;}_3=o.plugin;}if(arguments.length>1){this._plugins[_4]=_3;}else{this._plugins.push(_3);}_3.setEditor(this);if(dojo.isFunction(_3.setToolbar)){_3.setToolbar(this.toolbar);}},customUndo:dojo.isIE,editActionInterval:3,beginEditing:function(_8){if(!this._inEditing){this._inEditing=true;this._beginEditing(_8);}if(this.editActionInterval>0){if(this._editTimer){clearTimeout(this._editTimer);}this._editTimer=setTimeout(dojo.hitch(this,this.endEditing),this._editInterval);}},_steps:[],_undoedSteps:[],execCommand:function(_9){if(this.customUndo&&(_9=="undo"||_9=="redo")){return this[_9]();}else{try{if(this.customUndo){this.endEditing();this._beginEditing();}var r=this.inherited("execCommand",arguments);if(this.customUndo){this._endEditing();}return r;}catch(e){if(dojo.isMoz&&/copy|cut|paste/.test(_9)){var _b=dojo.string.substitute,_c={cut:"X",copy:"C",paste:"V"},_d=navigator.userAgent.indexOf("Macintosh")!=-1;alert(_b(this.commands.systemShortcutFF,[this.commands[_9],_b(this.commands[_d?"appleKey":"ctrlKey"],[_c[_9]])]));}return false;}}},queryCommandEnabled:function(_e){if(this.customUndo&&(_e=="undo"||_e=="redo")){return _e=="undo"?(this._steps.length>1):(this._undoedSteps.length>0);}else{return this.inherited("queryCommandEnabled",arguments);}},_changeToStep:function(_f,to){this.setValue(to.text);var b=to.bookmark;if(!b){return;}if(dojo.isIE){if(dojo.isArray(b)){var tmp=[];dojo.forEach(b,function(n){tmp.push(dijit.range.getNode(n,this.editNode));},this);b=tmp;}}else{var r=dijit.range.create();r.setStart(dijit.range.getNode(b.startContainer,this.editNode),b.startOffset);r.setEnd(dijit.range.getNode(b.endContainer,this.editNode),b.endOffset);b=r;}dojo.withGlobal(this.window,"moveToBookmark",dijit,[b]);},undo:function(){this.endEditing(true);var s=this._steps.pop();if(this._steps.length>0){this.focus();this._changeToStep(s,this._steps[this._steps.length-1]);this._undoedSteps.push(s);this.onDisplayChanged();return true;}return false;},redo:function(){this.endEditing(true);var s=this._undoedSteps.pop();if(s&&this._steps.length>0){this.focus();this._changeToStep(this._steps[this._steps.length-1],s);this._steps.push(s);this.onDisplayChanged();return true;}return false;},endEditing:function(_17){if(this._editTimer){clearTimeout(this._editTimer);}if(this._inEditing){this._endEditing(_17);this._inEditing=false;}},_getBookmark:function(){var b=dojo.withGlobal(this.window,dijit.getBookmark);if(dojo.isIE){if(dojo.isArray(b)){var tmp=[];dojo.forEach(b,function(n){tmp.push(dijit.range.getIndex(n,this.editNode).o);},this);b=tmp;}}else{var tmp=dijit.range.getIndex(b.startContainer,this.editNode).o;b={startContainer:tmp,startOffset:b.startOffset,endContainer:b.endContainer===b.startContainer?tmp:dijit.range.getIndex(b.endContainer,this.editNode).o,endOffset:b.endOffset};}return b;},_beginEditing:function(cmd){if(this._steps.length===0){this._steps.push({"text":this.savedContent,"bookmark":this._getBookmark()});}},_endEditing:function(_1c){var v=this.getValue(true);this._undoedSteps=[];this._steps.push({"text":v,"bookmark":this._getBookmark()});},onKeyDown:function(e){if(!this.customUndo){this.inherited("onKeyDown",arguments);return;}var k=e.keyCode,ks=dojo.keys;if(e.ctrlKey){if(k===90||k===122){dojo.stopEvent(e);this.undo();return;}else{if(k===89||k===121){dojo.stopEvent(e);this.redo();return;}}}this.inherited("onKeyDown",arguments);switch(k){case ks.ENTER:this.beginEditing();break;case ks.BACKSPACE:case ks.DELETE:this.beginEditing();break;case 88:case 86:if(e.ctrlKey&&!e.altKey&&!e.metaKey){this.endEditing();if(e.keyCode==88){this.beginEditing("cut");setTimeout(dojo.hitch(this,this.endEditing),1);}else{this.beginEditing("paste");setTimeout(dojo.hitch(this,this.endEditing),1);}break;}default:if(!e.ctrlKey&&!e.altKey&&!e.metaKey&&(e.keyCode<dojo.keys.F1||e.keyCode>dojo.keys.F15)){this.beginEditing();break;}case ks.ALT:this.endEditing();break;case ks.UP_ARROW:case ks.DOWN_ARROW:case ks.LEFT_ARROW:case ks.RIGHT_ARROW:case ks.HOME:case ks.END:case ks.PAGE_UP:case ks.PAGE_DOWN:this.endEditing(true);break;case ks.CTRL:case ks.SHIFT:case ks.TAB:break;}},_onBlur:function(){this.inherited("_onBlur",arguments);this.endEditing(true);},onClick:function(){this.endEditing(true);this.inherited("onClick",arguments);}});dojo.subscribe("dijit.Editor.getPlugin",null,function(o){if(o.plugin){return;}var _22=o.args,p;var _p=dijit._editor._Plugin;var _25=_22.name;switch(_25){case "undo":case "redo":case "cut":case "copy":case "paste":case "insertOrderedList":case "insertUnorderedList":case "indent":case "outdent":case "justifyCenter":case "justifyFull":case "justifyLeft":case "justifyRight":case "delete":case "selectAll":case "removeFormat":p=new _p({command:_25});break;case "bold":case "italic":case "underline":case "strikethrough":case "subscript":case "superscript":p=new _p({buttonClass:dijit.form.ToggleButton,command:_25});break;case "|":p=new _p({button:new dijit.ToolbarSeparator()});break;case "createLink":p=new dijit._editor.plugins.LinkDialog({command:_25});break;case "foreColor":case "hiliteColor":p=new dijit._editor.plugins.TextColor({command:_25});break;case "fontName":case "fontSize":case "formatBlock":p=new dijit._editor.plugins.FontChoice({command:_25});}o.plugin=p;});}